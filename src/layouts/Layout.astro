---
import { ClientRouter } from "astro:transitions";
import { PUBLIC_GOOGLE_SITE_VERIFICATION } from "astro:env/client";
import { SITE } from "@/config";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import "@/styles/global.css";

export interface Props {
  title?: string;
  author?: string;
  profile?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | null;
  scrollSmooth?: boolean;
  favicon?: string;
}

const {
  title = SITE.title,
  author = SITE.author,
  profile = SITE.profile,
  description = SITE.desc,
  ogImage = SITE.ogImage ? `/${SITE.ogImage}` : "/og.jpg",
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  pubDatetime,
  modDatetime,
  scrollSmooth = false,
  favicon,
} = Astro.props;

const socialImageURL = new URL(ogImage, Astro.url);

const structuredData = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  headline: `${title}`,
  image: `${socialImageURL}`,
  author: [
    { "@type": "Person", name: `${author}`, ...(profile && { url: profile }) },
  ],
};
---

<!doctype html>
<html
  dir={SITE.dir}
  lang={SITE.lang ?? "en"}
  class={scrollSmooth ? "scroll-smooth" : ""}
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />

    <!-- General Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="author" content={author} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Icons -->
    {
      favicon ? (
        <>
          <!-- Per-page override -->
          <link rel="icon" href={favicon} sizes="any" />
          <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
          <meta name="theme-color" content="#111827" />
        </>
      ) : (
        <>
          <!-- Site defaults -->
          <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg" />
          <link rel="icon" href="/icons/favicon.ico" sizes="any" />
          <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
          <link rel="manifest" href="/icons/manifest.webmanifest" />
          <meta name="theme-color" content="#111827" />
        </>
      )
    }

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Article Published/Modified time -->
    {
      pubDatetime && (
        <meta
          property="article:published_time"
          content={pubDatetime.toISOString()}
        />
      )
    }
    {
      modDatetime && (
        <meta
          property="article:modified_time"
          content={modDatetime.toISOString()}
        />
      )
    }

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <!-- Google JSON-LD Structured data -->
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(structuredData)}
    />

    <!-- RSS auto-discovery -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title={SITE.title}
      href={new URL("rss.xml", Astro.site)}
    />

    {
      PUBLIC_GOOGLE_SITE_VERIFICATION && (
        <meta
          name="google-site-verification"
          content={PUBLIC_GOOGLE_SITE_VERIFICATION}
        />
      )
    }

    <!-- Astro client router (partial navs) -->
    <ClientRouter />

    <!-- Theme toggle -->
    <script is:inline src="/toggle-theme.js"></script>

    <!-- Lightbox: delegated handler, safe across partial navigations -->
    <script is:inline>
      (function () {
        const OPEN_ATTR = 'data-open';

        function getDialog(id) {
          return id ? document.getElementById(id) : null;
        }

        function wireDialogAutoclose(dlg) {
          if (dlg.dataset.lbAutoclose === '1') return;
          dlg.dataset.lbAutoclose = '1';

          dlg.addEventListener('click', function (e) {
            if (e.target === dlg && typeof dlg.close === 'function') dlg.close();
          });

          dlg.addEventListener('close', function () {
            delete dlg.dataset.lbAutoclose;
          });
        }

        document.addEventListener('click', function (e) {
          var target = e.target instanceof Element ? e.target.closest('[' + OPEN_ATTR + ']') : null;
          if (!target) return;

          var id = target.getAttribute(OPEN_ATTR);
          var dlg = getDialog(id);
          if (!dlg || typeof dlg.showModal !== 'function') return;

          wireDialogAutoclose(dlg);
          dlg.showModal();
        });

        function closeAllDialogs() {
          document.querySelectorAll('dialog[open]').forEach(function (d) {
            try { d.close(); } catch (_) {}
          });
        }

        document.addEventListener('astro:after-swap', closeAllDialogs);
        document.addEventListener('astro:page-load', closeAllDialogs);
      })();
    </script>

    <!-- GoatCounter: load (no auto onload) -->
    <script
      data-goatcounter="https://jasperjapp.goatcounter.com/count"
      data-goatcounter-settings='{"no_onload": true}'
      async
      src="//gc.zgo.at/count.js"></script>

    <!-- GoatCounter: manual pageview + event tracking -->
    <script is:inline>
      (function () {
        function gcReady() {
          return typeof window !== 'undefined' &&
                 window.goatcounter &&
                 typeof window.goatcounter.count === 'function';
        }

        function gcCountPage() {
          if (!gcReady()) return;
          var path = location.pathname + location.search + location.hash;
          window.goatcounter.count({ path: path, title: document.title });
        }

        // Page views
        document.addEventListener('DOMContentLoaded', gcCountPage);
        document.addEventListener('astro:page-load', gcCountPage);
        document.addEventListener('astro:after-swap', gcCountPage);

        // Simple click events
        document.addEventListener('click', function (e) {
          var el = e.target instanceof Element ? e.target.closest('a,button,[data-analytics]') : null;
          if (!el || !gcReady()) return;

          // Project cards
          if (el.tagName === 'A' && el.getAttribute('data-analytics') === 'project') {
            var slug = el.getAttribute('data-project') || 'unknown';
            var title = el.getAttribute('data-title') || 'Project click';
            window.goatcounter.count({ path: '/event/project-click/' + slug, title: title, event: true });
          }

          // LinkedIn example
          if (el.tagName === 'A' && /linkedin\.com/i.test(el.href)) {
            window.goatcounter.count({ path: '/event/linkedin', title: 'LinkedIn Click', event: true });
          }
        });
      })();
    </script>
  </head>

  <body>
    <Header />
    <main id="main-content">
      <div class="mx-auto max-w-app px-4 sm:px-4 lg:px-10 pb-16 sm:pb-24 pb-[max(4rem,env(safe-area-inset-bottom))]">
        <slot />
      </div>
    </main>
    <Footer />

    <!-- GoatCounter noscript pixel (keep in body to avoid head layout quirks) -->
    <noscript>
      <img src="https://jasperjapp.goatcounter.com/count?p=/noscript" alt="" />
    </noscript>
  </body>
</html>

<style>
  html, body { margin: 0; width: 100%; height: 100%; }
</style>
